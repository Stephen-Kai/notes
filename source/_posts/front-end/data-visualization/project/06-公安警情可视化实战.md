---
title: 06-公安警情可视化实战
tag: 数据可视化
catogory:
  - front-end
  - 数据可视化
---

# 公安警情可视化

本项目应用 Vue.js 和 D3.js 开发的一套公安警情可视化系统。

## 环境搭建

将结果数据的每一个数据项，作为单个图元元素展示，大量的数据集构成数据图像，同时将数据的各个属性以多维度的方式展现，从而提高数据的可读性

```
vue create d3-project
yarn add d3 mockjs axios jquery -S
```

# 搭建页面结构

##### 1、修改 main.js

```js
// /main.js
import Vue from "vue";
import App from "./App.vue";

import "./assets/css/reset.css";
import "./assets/css/common.css";

import zoom from "./assets/scripts/tool/zoom";
zoom();
window.addEventListener("resize", zoom);

Vue.config.productionTip = false;

new Vue({
  render: (h) => h(App),
}).$mount("#app");
```

##### 2、添加基本样式

```css
/* /src/assets/css/reset.css */
html,
body,
div,
span,
applet,
object,
iframe,
h1,
h2,
h3,
h4,
h5,
h6,
p,
blockquote,
pre,
a,
abbr,
acronym,
address,
big,
cite,
code,
del,
dfn,
em,
img,
ins,
kbd,
q,
s,
samp,
small,
strike,
strong,
sub,
sup,
tt,
var,
b,
u,
i,
center,
dl,
dt,
dd,
ol,
ul,
li,
fieldset,
form,
label,
legend,
table,
caption,
tbody,
tfoot,
thead,
tr,
th,
td,
article,
aside,
canvas,
details,
embed,
figure,
figcaption,
footer,
header,
hgroup,
menu,
nav,
output,
ruby,
section,
summary,
time,
mark,
audio,
video {
  margin: 0;
  padding: 0;
  border: 0;
  font-size: 100%;
  font: inherit;
  vertical-align: baseline;
}

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
menu,
nav,
section {
  display: block;
}

body {
  line-height: 1;
}

li,
ol,
ul {
  list-style: none;
}

blockquote,
q {
  quotes: none;
}

blockquote:before,
blockquote:after,
q:before,
q:after {
  content: "";
  content: none;
}

table {
  border-collapse: collapse;
  border-spacing: 0;
}

a {
  text-decoration: none;
}
```

```css
/* /src/assets/css/common.css */
body {
  display: flex;
  transform-origin: 0px 0px 0px;
  overflow: hidden;
  position: relative;
  font-family: "微软雅黑";
}

.text-white-shadow {
  text-shadow: 0 0 5px #fbfbfb, 0 0 10px #fbfbfb, 0 0 20px #228dff, 0 0 35px
      #228dff, 0 0 75px #228dff;
}

.text-green-shadow {
  text-shadow: 0 0 5px #68fff3, 0 0 10px #68fff3, 0 0 20px #228dff, 0 0 35px
      #228dff, 0 0 75px #228dff;
}

.chart-title {
  font-size: 52px;
  color: #fff;
  position: absolute;
  top: 10px;
  left: 50px;
}

.auto-tooltip {
  box-sizing: border-box;
  position: absolute;
  padding: 10px 15px;
  background: rgba(59, 57, 54, 0.8);
  border-radius: 5px;
  border: 1px solid #928a82;
  color: #fff;
  font-size: 30px;
  z-index: 9999;
  white-space: nowrap;
  display: none;
}

.axis path,
.axis line {
  fill: none;
  stroke: none;
  shape-rendering: optimizeSpeed;
}

.axis text {
  font-size: 28px;
  font-family: sans-serif;
  fill: #a4d5ff;
}

.legend-hide {
  color: #8da5e4 !important;
}

.map-chart .xingzheng {
  transform: translate(0px, 8px);
}

.map-chart .xingshi .circleMain {
  fill: #0084ff;
}

.map-chart .xingzheng .circleMain {
  fill: #fff;
}

.map-chart .xingshi .circleOuter1,
.xingshi .circleOuter2 {
  stroke: #0084ff;
  fill: none;
}

.map-chart .xingzheng .circleOuter1,
.xingzheng .circleOuter2 {
  stroke: #fff;
  fill: none;
}

.circleOuter2 {
  animation: cri 1s infinite;
}

@keyframes cri {
  0%,
  100%,
  20%,
  40%,
  60%,
  80% {
    -webkit-transition-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
    transition-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
  }
  0% {
    transform: scale(1);
  }
  100% {
    transform: scale(1.5);
    opacity: 0;
  }
}

@-webkit-keyframes cri {
  0%,
  100%,
  20%,
  40%,
  60%,
  80% {
    -webkit-transition-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
    transition-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
  }
  0% {
    -webkit-transform: scale(1);
  }
  100% {
    -webkit-transform: scale(1.5);
    -webkit-opacity: 0;
  }
}

/* 添加页面背景图 */
.side-r-wrap {
  flex: 1;
  height: 100%;
  background: url(../../assets/images/common/page-bg.jpg) no-repeat;
  background-size: 100% 100%;
  position: relative;
  overflow: hidden;
}
```

##### 3、实现页面自动缩放

```js
// /main.js
import zoom from "./assets/scripts/tool/zoom";
zoom();
window.addEventListener("resize", zoom);
```

```js
// /src/assets/scripts/tool/zoom.js
import config from "./config";

export default () => {
  const { pageWidth, pageHeight } = config;

  const body = document.querySelector("body");

  body.style.width = `${pageWidth}px`;
  body.style.height = `${pageHeight}px`;
  const x = window.innerWidth / pageWidth;
  const y = window.innerHeight / pageHeight;
  body.style.transform = `scale(${x}, ${y})`;
};
```

```js
// /src/assets/scripts/tool/config.js
export default {
  pageWidth: 3360,
  pageHeight: 1890,
};
```

# 实现顶部信息展示

#### 1、App 组件 修改

/App.vue

```vue
<template>
  <div class="castle side-r-wrap">
    <TopSide :title="title"></TopSide>
    <TopMid></TopMid>
  </div>
</template>

<script>
import TopSide from "@/components/TopSide";
import TopMid from "@/components/TopMid";

export default {
  name: "Castle",
  data() {
    return {
      title: "公安警情可视化",
    };
  },
  components: {
    TopSide,
    TopMid,
  },
};
</script>
<style scoped></style>
```

#### 2、构建 TopSide.vue

/src/components/TopSide.vue

Mock 模块已经安装

```vue
<template>
  <div class="top-side">
    <div class="title">{{ title }}</div>
    <div class="time">
      {{ yyyyMMdd }}
      <strong>{{ HHmm }}</strong>
    </div>
  </div>
</template>
<script>
import Mock from "mockjs";
export default {
  props: ["title"],
  name: "topSide",
  data() {
    return {
      yyyyMMdd: "",
      HHmm: "",
    };
  },
  mounted() {
    const date = Mock.Random.now("yyyyMMddHHmm");
    const year = date.substring(0, 4);
    const month = date.substring(4, 6);
    const day = date.substring(6, 8);
    const hour = date.substring(8, 10);
    const minute = date.substring(10, 12);
    this.yyyyMMdd = `${year}.${month}.${day}`;
    this.HHmm = `${hour}:${minute}`;
  },
};
</script>
<style>
.top-side {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
}

.title {
  font-size: 58px;
  color: #fdfeff;
  position: absolute;
  left: 62px;
  top: 30px;
  text-shadow: 0 0 5px #fbfbfb, 0 0 10px #fbfbfb, 0 0 20px #228dff, 0 0 35px
      #228dff, 0 0 75px #228dff;
}

.time {
  position: absolute;
  top: 30px;
  right: 55px;
  color: #fdfeff;
  font-size: 36px;
  text-shadow: 0 0 5px #fbfbfb, 0 0 10px #fbfbfb, 0 0 20px #228dff, 0 0 35px
      #228dff, 0 0 75px #228dff;
}

.time strong {
  font-size: 60px;
}
</style>
```

#### 3、构建 TopMid.vue

/src/components/TopSide.vue

```vue
<template>
  <div class="top-mid">
    <div class="item" v-for="item in dataset" :key="item.id">
      <span class="name"
        >{{ item.name }}
        <strong>{{ item.value }}</strong>
      </span>
      <span class="huanbi"
        >环比
        <strong :data-state="item.state"
          >{{ item.huanbi }}
          <em>%</em>
        </strong>
      </span>
    </div>
  </div>
</template>
<script>
import axios from "axios";
import api from "../assets/scripts/tool/api";
import Data from "../data/fantasy/castle/top";
Data();
export default {
  name: "topMid",
  data() {
    return {
      dataset: [],
    };
  },
  mounted() {
    const self = this;
    axios
      .get(api.castleTop)
      .then((response) => {
        const data = response.data.result.top;
        data.map((item) => {
          let state;
          let huanbi;
          if (item.huanbi > 0) {
            state = "up";
            huanbi = item.huanbi;
          } else if (item.huanbi === 0) {
            state = "level";
            huanbi = item.huanbi;
          } else if (item.huanbi < 0) {
            state = "down";
            huanbi = Math.abs(item.huanbi);
          }
          self.dataset.push({
            name: item.name,
            value: item.value,
            huanbi: huanbi,
            state: state,
          });
        });
      })
      .catch((error) => {
        console.error(error);
      });
  },
};
</script>
<style>
.top-mid {
  position: absolute;
  left: 50%;
  top: 30px;
  width: 1650px;
  display: flex;
  justify-content: space-around;
  box-sizing: border-box;
  padding: 24px 20px 0;
  background: url(../assets/images/common/top-center-bg.png) no-repeat top
    center;
  background-size: 100% 100%;
  transform: translate(-50%, 0);
  margin-left: -20px;
}

.item {
  max-width: 33.33%;
  overflow: hidden;
  white-space: nowrap;
}

.name {
  font-size: 40px;
  color: #b4c7f9;
}

.name strong {
  font-size: 50px;
  color: #ff8244;
  font-weight: normal;
  margin: 0 10px;
}

.huanbi {
  font-size: 30px;
  color: #b4c7f9;
}

.huanbi strong {
  font-size: 40px;
  margin: 0 10px 0 36px;
  position: relative;
  display: inline-block;
}

.huanbi em {
  font-size: 30px;
}

.huanbi strong[data-state]:after {
  content: "";
  display: inline-block;
  position: absolute;
  width: 25px;
  height: 26px;
  top: 14px;
  left: -30px;
}

.huanbi strong[data-state="up"] {
  color: #ff4444;
}

.huanbi strong[data-state="level"] {
  color: #b4c7f9;
}

.huanbi strong[data-state="down"] {
  color: #44ff86;
}

.huanbi strong[data-state="up"]:after {
  background: url(../assets/images/common/huanbi-up.png) no-repeat;
}

.huanbi strong[data-state="down"]:after {
  background: url(../assets/images/common/huanbi-down.png) no-repeat;
}
</style>
```

##### /src/assets/scripts/tool/api

```js
const isOnline = false;
const onlineApiHost = isOnline
  ? "http://88.888.88.88:8888/project/"
  : "http://localhost:8080/";

export default {
  castleTop: onlineApiHost + "fantasy/castle/top",
  iotalarm: onlineApiHost + "iot/overview/alarm",
  iottop5: onlineApiHost + "iot/overview/top5",
  iottrend: onlineApiHost + "iot/overview/trend",
  district: onlineApiHost + "stride/fireworks/city",
  list: onlineApiHost + "stride/fireworks/list",
  dotemap: onlineApiHost + "fantasy/castle/dotemap",
};
```

##### /src/data/fantasy/castle/top

```js
import { urlReg } from "../../../assets/scripts/tool/utils";

import Mock from "mockjs";

const data = () => {
  Mock.mock(urlReg("fantasy/castle/top"), {
    code: 1,
    msg: "success",
    result: {
      "top|3": [
        {
          "name|+1": ["本周", "本月", "本年"],
          value: "@natural(100,10000)",
          huanbi: "@integer(-100,100)",
        },
      ],
    },
  });
};

export default data;
```

##### /src/assets/scripts/tool/utils

```js
import $ from "jquery";

export const urlReg = (name) => {
  const protocols = "((https?|s?ftp|irc[6s]?|git|afp|telnet|smb):\\/\\/)?";
  const userInfo = "([a-z0-9]\\w*(\\:[\\S]+)?\\@)?";
  const domain =
    "([a-z0-9]([\\w]*[a-z0-9])*\\.)?[a-z0-9]\\w*\\.[a-z]{2,}(\\.[a-z]{2,})?";
  const port = "(:\\d{1,5})?";
  const ip = "\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}";
  const address = "(\\/\\S*)?";
  const domainType = [
    protocols,
    userInfo,
    domain,
    port,
    address,
    name,
    address,
  ];
  const ipType = [protocols, userInfo, ip, port, address, name, address];
  return (
    new RegExp("^" + domainType.join("") + "$", "i") ||
    new RegExp("^" + ipType.join("") + "$", "i")
  );
};

export const tooltip = (option) => {
  const el = option.el;
  let location = option.location;
  const data = option.data;
  const length = data.length;
  let text = "";
  for (let i = 0; i < length; i++) {
    if (data[i].color) {
      text += `<span style="color:${data[i].color}">${data[i].name} : ${data[i].value}</span><br>`;
    } else {
      text += `<span>${data[i].name} : ${data[i].value}</span><br>`;
    }
  }
  $(el).html(text);
  const globalWidth = $("body").outerWidth();
  const elWidth = $(el).outerWidth();
  const elHeight = $(el).outerHeight();
  location.x = location.x - elWidth / 2;
  location.y = location.y - elHeight - 10;
  if (location.x + elWidth / 2 > globalWidth) {
    location.x = globalWidth - elWidth;
  }
  $(el).css({
    left: location.x,
    top: location.y,
  });
  return $(el);
};
```

# 构建左侧信息展示

#### 1、App 组件 修改

/App.vue

```vue
<template>
  <div class="castle side-r-wrap">
    <TopSide :title="title"></TopSide>
    <TopMid></TopMid>
    <Left></Left>
  </div>
</template>

<script>
import TopSide from "@/components/TopSide";
import TopMid from "@/components/TopMid";
import Left from "@/components/Left";

export default {
  name: "Castle",
  data() {
    return {
      title: "公安警情可视化",
    };
  },
  components: {
    TopSide,
    TopMid,
    Left,
  },
};
</script>
<style scoped></style>
```

##### 2、构建 Left.vue

/src/components/Left.vue

```vue
<template>
  <div class="left">
    <div class="diandongche">
      <h2 class="chart-title">年度刑事案件数</h2>
      <ul class="alarm-list">
        <li>
          <p class="alarm-list-name">
            <span>今年</span>
          </p>
          <p class="alarm-list-value">{{ thisyear }}</p>
        </li>
        <li>
          <p class="alarm-list-name">
            <span>环比</span>
          </p>
          <p class="alarm-list-value" :data-state="hbstate">{{ huanbi }}</p>
        </li>
        <li>
          <p class="alarm-list-name">
            <span>去年</span>
          </p>
          <p class="alarm-list-value">{{ lastyear }}</p>
        </li>
      </ul>
    </div>
    <div class="caseResolved">
      <h2 class="chart-title">年度出警数</h2>
      <div class="case-resolved-chart" id="caseResolvedChart"></div>
    </div>
  </div>
</template>
<script>
import axios from "axios";
import api from "../assets/scripts/tool/api";
import Data from "../data/fantasy/castle/left";
import MultiPie from "../assets/scripts/charts/multiPie";
Data();

export default {
  name: "left",
  data() {
    return {
      thisyear: "",
      hbstate: "",
      huanbi: "",
      lastyear: "",
    };
  },
  mounted() {
    const self = this;
    axios
      .get(api.iotalarm)
      .then((response) => {
        const data = response.data.result;
        self.dealDDC(data.diandongche);
        self.dealCase(data.caseResolved);
      })
      .catch((error) => {
        console.error(error);
      });
  },
  methods: {
    dealDDC(data) {
      let hbstate;
      let hbValue = data.huanbi;
      if (hbValue < 0) {
        hbstate = "down";
        hbValue = Math.abs(hbValue);
      } else if (hbValue === 0) {
        hbstate = "level";
        hbValue = "- 0";
      } else if (hbValue > 0) {
        hbstate = "up";
        hbValue = Math.abs(hbValue);
      }
      this.thisyear = data.thisyear;
      this.hbstate = hbstate;
      this.huanbi = hbValue;
      this.lastyear = data.lastyear;
    },
    dealCase(data) {
      const config = {};
      const multiPie = new MultiPie(".case-resolved-chart", config);
      multiPie.render(data);
    },
  },
};
</script>
<style scoped>
.diandongche {
  position: absolute;
  top: 220px;
  left: 60px;
  width: 680px;
  height: 600px;
  background: url(../assets/images/common/tip-title-bg.png) no-repeat top left;
}

.alarm-list {
  position: absolute;
  top: 120px;
  left: 0px;
  width: 100%;
  height: 100%;
  font-size: 0;
}

.alarm-list li {
  width: 50%;
  height: 190px;
  overflow: hidden;
  display: inline-block;
  margin-bottom: 10px;
}

.alarm-list-name span {
  font-size: 50px;
  color: #b4c7f9;
  position: relative;
  display: inline-block;
}

.alarm-list-name span:after {
  content: "件";
  display: inline-block;
  position: absolute;
  top: 4px;
  right: -80px;
  text-align: center;
  font-size: 30px;
  line-height: 46px;
  color: #8da5e4;
  height: 46px;
  width: 60px;
  background: #0c3f87;
  border: 1px solid #443cba;
}

.alarm-list li:nth-child(2) .alarm-list-name span:after {
  display: none;
}

.alarm-list-value {
  font-size: 60px;
  color: #1aac4e;
  position: relative;
  display: inline-block;
  margin-top: 20px;
}

.alarm-list li:first-child .alarm-list-value {
  font-size: 90px;
  color: #44ff86;
}

.alarm-list li:nth-child(2) .alarm-list-value {
  margin-top: 34px;
  text-indent: 40px;
}

.alarm-list li:nth-child(2) .alarm-list-value[data-state="up"] {
  color: #ff4444;
}

.alarm-list li:nth-child(2) .alarm-list-value[data-state="level"] {
  color: #b4c7f9;
}

.alarm-list li:nth-child(2) .alarm-list-value[data-state="down"] {
  color: #44ff86;
}

.alarm-list li:nth-child(2) .alarm-list-value:after {
  content: "%";
  display: inline-block;
  position: absolute;
  bottom: 4px;
  right: -24px;
  font-size: 30px;
}

.alarm-list li:nth-child(2) .alarm-list-value[data-state]:before {
  content: "";
  display: inline-block;
  position: absolute;
  width: 25px;
  height: 26px;
  top: 26px;
  left: 0px;
}

.alarm-list li:nth-child(2) .alarm-list-value[data-state="up"]:before {
  background: url(../assets/images/common/huanbi-up.png) no-repeat;
}

.alarm-list li:nth-child(2) .alarm-list-value[data-state="down"]:before {
  background: url(../assets/images/common/huanbi-down.png) no-repeat;
}

.caseResolved {
  position: absolute;
  top: 830px;
  left: 60px;
  background: url(../assets/images/common/tip-title-bg.png) no-repeat top left;
}

.case-resolved-chart {
  width: 900px;
  height: 270px;
  margin-top: 130px;
}
</style>
```

##### /src/data/fantasy/castle/left.js

```js
import { urlReg } from "../../../assets/scripts/tool/utils";

import Mock from "mockjs";

const data = () => {
  Mock.mock(urlReg("/iot/overview/alarm"), {
    code: 1,
    msg: "success",
    result: {
      diandongche: {
        lastyear: "@natural(1,2000)",
        thisyear: "@natural(1,2000)",
        huanbi: "@integer(-100,100)",
      },
      "caseResolved|3": [
        {
          "name|+1": ["部门一", "部门二", "部门三"],
          value: "@natural(1,2000)",
        },
      ],
    },
  });
};
export default data;
```

##### /src/assets/scripts/charts/multiPie.js

```js
import * as d3 from "d3";

export default class MultiPie {
  /**
   *  默认配置项
   *  @return   {[Object]}  [默认配置项]
   */
  defaultSetting() {
    return {
      width: 900,
      height: 270,
      radius: [50, 66], // [innerRadius,outerRadius]
      gap: 100, // 相邻两个图形的间距
      margin: {
        // 多个图形布局：从左往右，竖直方向按容器高度居中放置，故只设置左侧距离left即可
        left: 10,
      },
      label: {
        // 名称文本样式
        normal: {
          fontSize: 32,
          color: "#46aaff",
          anchor: "middle",
          cursor: "pointer",
          top: 46, // 名称文本距离图案顶部的距离
        },
        emphasis: {
          fontSize: 32,
          color: "#74ffd3",
          anchor: "middle",
          cursor: "pointer",
          top: 46, // 名称文本距离图案顶部的距离
        },
      },
      itemStyle: {
        label: {
          // value值文本样式
          fontSize: 32,
          color: "#46aaff",
          anchor: "middle",
          cursor: "pointer",
          top: 10, // value值文本距离容器中线的偏移距离，默认放在饼图正中间
        },
        color: [
          // 饼图填充色
          ["#4a8ce5", "black"],
          ["#44ff86", "black"],
          ["#dccc5c", "black"],
        ],
      },
    };
  }
  /**
   *  初始化，创建容器
   *  @param    {String}  selector 图表容器，支持class或id
   *  @param    {Object}  option   配置项，控制图形样式
   *  @return   {[type]}  [description]
   */
  constructor(selector, option = {}) {
    const defaultSetting = this.defaultSetting();
    this.config = Object.assign(defaultSetting, option);
    const { width, height } = this.config;
    // 创建svg
    this.svg = d3
      .select(selector)
      .append("svg")
      .attr("width", width)
      .attr("height", height);
  }
  /**
   *  处理原始数据，获取pie布局转换后的数据
   *  @param    {Array}  data    原始数据
   *  @return   {Array}  dataset 转换后的数据
   */
  getDataset(data) {
    let dataset = [];
    const clockwisePie = d3.pie(); // 顺时针，针对数据类型:[small,bigger]
    const anticlockwisePie = d3
      .pie() // 逆时针,针对数据类型：[bigger,small]
      .startAngle(0)
      .endAngle(-2 * Math.PI);
    // 求取总数：sum
    let sum = 0;
    data.map((d) => {
      sum += parseInt(d.value, 10);
    });
    data.map((d) => {
      let value = d.value;
      let rate = Math.max(Math.floor((value * 100) / sum), 1);
      let rateData = [rate, 100 - rate];
      let dealData =
        rate >= 50 ? clockwisePie(rateData) : anticlockwisePie(rateData);
      dataset.push(dealData);
    });
    return dataset;
  }
  /**
   *  绘制图案底部的名称文本
   *  @param    {Object}  chart 包裹文本的外层g容器
   *  @param    {Object}  info  单组原始数据，包括name和value
   *  @return   {[type]}  [description]
   */
  renderName(chart, info) {
    const {
      radius: [, outerRadius],
      label: {
        normal: {
          fontSize: fontSizeNor,
          color: colorNor,
          anchor: anchorNor,
          top: topNor,
          cursor: cursorNor,
        },
        emphasis: {
          fontSize: fontSizeEmp,
          color: colorEmp,
          anchor: anchorEmp,
          top: topEmp,
          cursor: cursorEmp,
        },
      },
    } = this.config;
    chart
      .select(".pie-name")
      .attr("font-size", fontSizeNor)
      .attr("fill", colorNor)
      .attr("text-anchor", anchorNor)
      .attr("transform", `translate(0, ${outerRadius + topNor})`)
      .attr("cursor", cursorNor)
      .text(info.name)
      .on("mouseover", function () {
        d3.select(this)
          .attr("font-size", fontSizeEmp)
          .attr("fill", colorEmp)
          .attr("text-anchor", anchorEmp)
          .attr("transform", `translate(0, ${outerRadius + topEmp})`)
          .attr("cursor", cursorEmp);
      })
      .on("mouseout", function () {
        d3.select(this)
          .attr("font-size", fontSizeNor)
          .attr("fill", colorNor)
          .attr("text-anchor", anchorNor)
          .attr("transform", `translate(0, ${outerRadius + topNor})`)
          .attr("cursor", cursorNor);
      });
  }
  /**
   *  绘制图案中间的value值文本
   *  @param    {Object}  chart 包裹文本的外层g容器
   *  @param    {[type]}  info  单组原始数据，包括name和value
   *  @return   {[type]}  [description]
   */
  renderValue(chart, info) {
    const {
      itemStyle: {
        label: { fontSize, color, anchor, cursor, top },
      },
    } = this.config;
    chart
      .select(".pie-value")
      .attr("font-size", fontSize)
      .attr("fill", color)
      .attr("text-anchor", anchor)
      .attr("transform", `translate(0,${top})`)
      .attr("cursor", cursor)
      .text(info.value);
  }
  /**
   *  绘制单个Pie图案
   *  @param    {Objec}  chartName  单个图案的外层g容器
   *  @param    {Array}   pieData   绘制饼图的数据（已经过布局处理）
   *  @param    {Object}  info      该图案的原始数据，包括name和value
   *  @param    {Array}   color     填充饼图的两个颜色值
   *  @return   {[type]}  [description]
   */
  creatPie(chartName, pieData, info, color) {
    const {
      radius: [innerRadius, outerRadius],
    } = this.config;
    const arc = d3.arc().innerRadius(innerRadius).outerRadius(outerRadius);
    const chart = this.svg.select(chartName);
    const update = chart.selectAll("path").data(pieData);
    const enter = update.enter();
    update.exit().remove();
    // 绘制饼图图案
    enter.append("path");
    chart
      .selectAll("path")
      .data(pieData)
      .attr("fill", (d, i) => {
        return color[i];
      })
      .attr("d", (d) => {
        return arc(d);
      });
    // 绘制名称--name
    enter.append("text").attr("class", "pie-name");
    this.renderName(chart, info);

    // 绘制value值
    enter.append("text").attr("class", "pie-value");
    this.renderValue(chart, info);
  }
  render(data) {
    let dataset = this.getDataset(data);
    const update = this.svg.selectAll(".item").data(dataset);
    update.enter().append("g").attr("class", "item");
    update.exit().remove();
    // 多个图形布局：从左往右，相邻图形间隔为配置项----config.gap
    const {
      height,
      radius: [, R],
      gap,
      margin: { left },
      itemStyle: { color },
    } = this.config;
    this.svg
      .selectAll(".item")
      .data(dataset)
      .attr("transform", (d, i) => {
        return `translate(${R + left + 2 * R * i + i * gap},${height / 2})`;
      })
      .attr("class", (d, i) => {
        return `item${i} item`;
      });
    // 逐个绘制饼图
    dataset.map((d, i) => {
      this.creatPie(`.item${i}`, d, data[i], color[i]);
    });
  }
}
```

# 绘制环状图

利用 D3 按照部门构造环状图，构建年底出警数可视化。

### 1、修改 Left.vue

##### 模板

```html
<div class="caseResolved">
  <h2 class="chart-title">年度出警数</h2>
  <div class="case-resolved-chart" id="caseResolvedChart"></div>
</div>
```

##### 逻辑

```js
mounted() {
  axios.get(api.castleLeft)
    .then(result => {
      // ...

      // 1、在mounted里添加：
      this.dealCase(data.caseResolved)
    })
},

// 2、在 methods 里添加：
dealCase (data) {
  const config = {}
  const multiPie = new MultiPie('.case-resolved-chart', config)
  multiPie.render(data)
}

// 3、导入模块
import MultiPie from '../assets/scripts/charts/multiPie'
```

### 2、安装 d3.js

```
yarn add d3 -S
```

### 3、构建 D3 环图

在 /src/assets/scripts/charts/ 下创建 multiPie.js 文件：

```js
import * as d3 from "d3";

export default class MultiPie {
  /**
   *  默认配置项
   *  @return   {[Object]}  [默认配置项]
   */
  defaultSetting() {
    return {
      width: 900,
      height: 270,
      radius: [50, 66], // [innerRadius,outerRadius]
      gap: 100, // 相邻两个图形的间距
      margin: {
        // 多个图形布局：从左往右，竖直方向按容器高度居中放置，故只设置左侧距离left即可
        left: 10,
      },
      label: {
        // 名称文本样式
        normal: {
          fontSize: 32,
          color: "#46aaff",
          anchor: "middle",
          cursor: "pointer",
          top: 46, // 名称文本距离图案顶部的距离
        },
        emphasis: {
          fontSize: 32,
          color: "#74ffd3",
          anchor: "middle",
          cursor: "pointer",
          top: 46, // 名称文本距离图案顶部的距离
        },
      },
      itemStyle: {
        label: {
          // value值文本样式
          fontSize: 32,
          color: "#46aaff",
          anchor: "middle",
          cursor: "pointer",
          top: 10, // value值文本距离容器中线的偏移距离，默认放在饼图正中间
        },
        color: [
          // 饼图填充色
          ["#4a8ce5", "black"],
          ["#44ff86", "black"],
          ["#dccc5c", "black"],
        ],
      },
    };
  }

  /**
   *  初始化，创建容器
   *  @param    {String}  selector 图表容器，支持class或id
   *  @param    {Object}  option   配置项，控制图形样式
   *  @return   {[type]}  [description]
   */
  constructor(selector, option = {}) {
    const defaultSetting = this.defaultSetting();
    this.config = Object.assign(defaultSetting, option);
    const { width, height } = this.config;
    // 创建svg
    this.svg = d3
      .select(selector)
      .append("svg")
      .attr("width", width)
      .attr("height", height);
  }

  /**
   *  处理原始数据，获取pie布局转换后的数据
   *  @param    {Array}  data    原始数据
   *  @return   {Array}  dataset 转换后的数据
   */

  getDataset(data) {
    let dataset = [];
    const clockwisePie = d3.pie(); // 顺时针，针对数据类型:[small,bigger]
    const anticlockwisePie = d3
      .pie() // 逆时针,针对数据类型：[bigger,small]
      .startAngle(0)
      .endAngle(-2 * Math.PI);
    // 求取总数：sum
    let sum = 0;
    data.map((d) => {
      sum += parseInt(d.value, 10);
    });
    data.map((d) => {
      let value = d.value;
      let rate = Math.max(Math.floor((value * 100) / sum), 1);
      let rateData = [rate, 100 - rate];
      let dealData =
        rate >= 50 ? clockwisePie(rateData) : anticlockwisePie(rateData);
      dataset.push(dealData);
    });
    return dataset;
  }

  /**
   *  绘制图案底部的名称文本
   *  @param    {Object}  chart 包裹文本的外层g容器
   *  @param    {Object}  info  单组原始数据，包括name和value
   *  @return   {[type]}  [description]
   */
  renderName(chart, info) {
    const {
      radius: [, outerRadius],
      label: {
        normal: {
          fontSize: fontSizeNor,
          color: colorNor,
          anchor: anchorNor,
          top: topNor,
          cursor: cursorNor,
        },
        emphasis: {
          fontSize: fontSizeEmp,
          color: colorEmp,
          anchor: anchorEmp,
          top: topEmp,
          cursor: cursorEmp,
        },
      },
    } = this.config;
    chart
      .select(".pie-name")
      .attr("font-size", fontSizeNor)
      .attr("fill", colorNor)
      .attr("text-anchor", anchorNor)
      .attr("transform", `translate(0, ${outerRadius + topNor})`)
      .attr("cursor", cursorNor)
      .text(info.name)
      .on("mouseover", function () {
        d3.select(this)
          .attr("font-size", fontSizeEmp)
          .attr("fill", colorEmp)
          .attr("text-anchor", anchorEmp)
          .attr("transform", `translate(0, ${outerRadius + topEmp})`)
          .attr("cursor", cursorEmp);
      })
      .on("mouseout", function () {
        d3.select(this)
          .attr("font-size", fontSizeNor)
          .attr("fill", colorNor)
          .attr("text-anchor", anchorNor)
          .attr("transform", `translate(0, ${outerRadius + topNor})`)
          .attr("cursor", cursorNor);
      });
  }

  /**
   *  绘制图案中间的value值文本
   *  @param    {Object}  chart 包裹文本的外层g容器
   *  @param    {[type]}  info  单组原始数据，包括name和value
   *  @return   {[type]}  [description]
   */
  renderValue(chart, info) {
    const {
      itemStyle: {
        label: { fontSize, color, anchor, cursor, top },
      },
    } = this.config;
    chart
      .select(".pie-value")
      .attr("font-size", fontSize)
      .attr("fill", color)
      .attr("text-anchor", anchor)
      .attr("transform", `translate(0,${top})`)
      .attr("cursor", cursor)
      .text(info.value);
  }

  /**
   *  绘制单个Pie图案
   *  @param    {Objec}  chartName  单个图案的外层g容器
   *  @param    {Array}   pieData   绘制饼图的数据（已经过布局处理）
   *  @param    {Object}  info      该图案的原始数据，包括name和value
   *  @param    {Array}   color     填充饼图的两个颜色值
   *  @return   {[type]}  [description]
   */
  creatPie(chartName, pieData, info, color) {
    const {
      radius: [innerRadius, outerRadius],
    } = this.config;
    const arc = d3.arc().innerRadius(innerRadius).outerRadius(outerRadius);
    const chart = this.svg.select(chartName);
    const update = chart.selectAll("path").data(pieData);
    const enter = update.enter();
    update.exit().remove();
    // 绘制饼图图案
    enter.append("path");
    chart
      .selectAll("path")
      .data(pieData)
      .attr("fill", (d, i) => {
        return color[i];
      })
      .attr("d", (d) => {
        return arc(d);
      });
    // 绘制名称--name
    enter.append("text").attr("class", "pie-name");
    this.renderName(chart, info);

    // 绘制value值
    enter.append("text").attr("class", "pie-value");
    this.renderValue(chart, info);
  }

  render(data) {
    let dataset = this.getDataset(data);
    const update = this.svg.selectAll(".item").data(dataset);
    update.enter().append("g").attr("class", "item");
    update.exit().remove();
    // 多个图形布局：从左往右，相邻图形间隔为配置项----config.gap
    const {
      height,
      radius: [, R],
      gap,
      margin: { left },
      itemStyle: { color },
    } = this.config;
    this.svg
      .selectAll(".item")
      .data(dataset)
      .attr("transform", (d, i) => {
        return `translate(${R + left + 2 * R * i + i * gap},${height / 2})`;
      })
      .attr("class", (d, i) => {
        return `item${i} item`;
      });
    // 逐个绘制饼图
    dataset.map((d, i) => {
      this.creatPie(`.item${i}`, d, data[i], color[i]);
    });
  }
}
```

# 绘制水泡图

D3 绘制右侧水泡图。

### 1、修改 App.vue

添加 Right 组件。

```vue
<template>
  <div class="side-r-wrap">
    // ...
    <Right></Right>
  </div>
</template>

<script>
// ...
import Right from "@/components/Right";

export default {
  // ...

  components: {
    // ...
    Right,
  },
};
</script>
```

### 2、构建 Right 组件

在 /src/components/ 创建 Right.vue：

```vue
<template>
  <div class="right">
    <div class="people-sex">
      <h2 class="chart-title">男女干警比例</h2>
      <div class="sex-chart" id="sexChart">
        <svg>
          <defs>
            <linearGradient id="outline" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop
                offset="0%"
                style="stop-color: rgb(6, 124, 255); stop-opacity: 1;"
              ></stop>
              <stop
                offset="100%"
                style="stop-color: rgb(160, 60, 218);stop-opacity: 1;"
              ></stop>
            </linearGradient>
            <linearGradient id="innerBall" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop
                offset="0%"
                style="stop-color: rgb(6, 124, 255); stop-opacity: 1;"
              ></stop>
              <stop
                offset="100%"
                style="stop-color: rgb(160, 60, 218);stop-opacity: 1;"
              ></stop>
            </linearGradient>
          </defs>
        </svg>
      </div>
      <div class="sex-legend">
        <p class="male">
          男性
          <span>{{ male }}</span>
          <em>%</em>
        </p>
        <p class="female">
          女性
          <span>{{ 100 - male }}</span>
          <em>%</em>
        </p>
      </div>
    </div>
  </div>
</template>
<script>
import * as d3 from "d3";
import axios from "axios";
import WaterBall from "../assets/scripts/charts/waterBall";
import api from "../assets/scripts/tool/api";
import Data from "../data/bandTop";
Data();
export default {
  name: "right",
  data() {
    return {
      male: 0,
    };
  },
  mounted() {
    const self = this;
    axios
      .get(api.iottop5)
      .then((response) => {
        const data = response.data.result;
        self.deal(data.sex);
      })
      .catch((error) => {
        console.error(error);
      });
  },
  methods: {
    deal(data) {
      this.male = data.male;
      const config = {};
      const waterBall = new WaterBall("#sexChart", config);
      waterBall.drawCharts(data);
    },
  },
};
</script>
<style scoped>
.people-sex {
  position: absolute;
  top: 220px;
  right: 70px;
  width: 540px;
  height: 516px;
  background: url(../assets/images/common/tip-title-bg.png) no-repeat top left;
}

.sex-chart {
  margin-top: 70px;
}

.sex-legend {
  position: absolute;
  top: 50%;
  right: 4%;
  transform: translateY(-50%);
}

.sex-legend p {
  font-size: 38px;
  color: #fff;
  padding-left: 40px;
  line-height: 1.5;
}

.sex-legend p span {
  color: #44ff86;
  font-size: 40px;
  margin: 0 12px 0 8px;
}

.sex-legend p em {
  color: #44ff86;
  font-size: 28px;
}

.sex-legend .male {
  background: url(../assets/images/fantasy/castle/male-legend.png) no-repeat
    left center;
}

.sex-legend .female {
  background: url(../assets/images/fantasy/castle/female-legend.png) no-repeat
    left center;
}

.jizhan {
  position: absolute;
  top: 743px;
  right: 70px;
  width: 540px;
  height: 690px;
  background: url(../assets/images/common/tip-title-bg.png) no-repeat top left;
}

.jizhan-list {
  margin-top: 136px;
}

.jizhan-item {
  width: 100%;
  height: 100px;
  margin-top: 10px;
  background: url(../assets/images/fantasy/castle/top-item-bg.png) 0% 0% / 100%
    100% no-repeat;
}

.jizhan-item-index {
  float: left;
  height: 100%;
  line-height: 100px;
  width: 82px;
  text-align: center;
  color: #14c7fb;
  font-size: 36px;
}

.jizhan-item-container {
  float: left;
  box-sizing: border-box;
  height: 100%;
  padding: 20px 0px 20px 10px;
}

.jizhan-bar-container {
  width: 445px;
  height: 25px;
  line-height: 25px;
}

.jizhan-back-bar {
  position: relative;
  float: left;
  width: 360px;
  height: 24px;
  margin-right: 10px;
  background: url(../assets/images/fantasy/castle/top-progress-bg.png) 0% 0% /
    100% 100% no-repeat;
}

.jizhan-outer-bar {
  position: absolute;
  top: 0;
  left: 0;
  height: 24px;
  background: linear-gradient(to right, #1963a7 0%, #bec374 100%);
}

.jizhan-value {
  float: left;
  color: #3da3ff;
  font-size: 30px;
}

.jizhan-item-name {
  font-size: 30px;
  color: #b0caf9;
}
</style>
```

### 3、构建 api

修改 /src/assets/scripts/tool/api.js：

```js
export default {
  // ...
  iottop5: onlineApiHost + "iot/overview/top5",
};
```

### 4、制作模拟数据

在 /src/data 下创建 bandTop.js 文件：

```js
import { urlReg } from "../assets/scripts/tool/utils";

import Mock from "mockjs";

const data = () => {
  Mock.mock(urlReg("/iot/overview/top5"), {
    code: 1,
    msg: "success",
    result: {
      sex: {
        male: "@natural(20,80)",
        female: "@natural(20,80)",
      },
    },
  });
};
export default data;
```

### 5、利用 D3 制作水泡图

在 /assets/scripts/charts/ 创建 waterBall.js 文件：

```js
// /assets/scripts/charts/waterBall.js

/*
 * @Description: 水球图
 */
import * as d3 from "d3";
export default class WaterBall {
  defaultSetting() {
    return {
      width: 400,
      height: 400,
      radius: 120,
      fillOuterLine: "url(#outline)", // 外圈圆
      innerBall: "url(#innerBall)", // 100% 实心圆填充
    };
  }

  constructor(selector, option) {
    const defaultSetting = this.defaultSetting();
    this.config = Object.assign(defaultSetting, option);
    const { width, height } = this.config;

    // 创建svg
    this.svg = d3
      .select(selector)
      .select("svg")
      .attr("width", width)
      .attr("height", height);
    this.defs = this.svg.select("defs");
  }

  drawCharts(data) {
    const { width, height, radius, innerBall, fillOuterLine } = this.config;

    let rate = data.male;
    const dataset = [[rate, 100 - rate]];

    // 设置布局
    const clockwisePie = d3
      .pie() // 顺时针，针对数据类型:[small,bigger]
      .startAngle(Math.PI)
      .endAngle(3 * Math.PI);

    const anticlockwisePie = d3
      .pie() // 逆时针,针对数据类型：[bigger,small]
      .startAngle(Math.PI)
      .endAngle(-Math.PI);

    // 绘制男性
    const maleArc = d3
      .arc()
      .innerRadius(radius - 8)
      .outerRadius(radius + 8);

    // 绘制女性
    const femaleArc = d3
      .arc()
      .innerRadius(radius - 30)
      .outerRadius(radius - 14);

    // 处理好结构
    const ballUpdate = this.svg.selectAll(".ball").data(dataset);

    const ballEnter = ballUpdate.enter().append("g").attr("class", "ball");
    ballUpdate.exit().remove();

    const ballGroup = this.svg
      .selectAll(".ball")
      .data(dataset)
      .attr("transform", `translate(${width / 2 - 50},${height / 2})`);

    // 绘制内部实心圆
    ballEnter.append("circle").attr("class", "innerCircle");
    ballGroup
      .select(".innerCircle")
      .attr("r", radius - 14)
      .attr("fill", "rgba(79,35,129,0.6)");

    // 绘制100%的实心圆
    ballEnter.append("circle").attr("class", "fillCircle");
    ballGroup
      .select(".fillCircle")
      .attr("r", radius - 14)
      .attr("fill", innerBall)
      .attr("clip-path", "url(#areaWave)");

    // 绘制外圈渐变填充圆
    ballEnter.append("circle").attr("class", "outLine");
    ballGroup
      .select(".outLine")
      .attr("r", radius)
      .attr("fill", "none")
      .attr("stroke", fillOuterLine)
      .attr("stroke-width", 4);

    // 绘制外圈纯色填充圆 -- 男性占比
    ballEnter.append("path").attr("class", "maleCircle");
    ballGroup
      .select(".maleCircle")
      .attr("fill", "#01e2fa")
      .attr("d", (d) => {
        return d[0] >= d[1]
          ? maleArc(clockwisePie(d)[0])
          : maleArc(anticlockwisePie(d)[0]);
      });

    // 绘制外圈纯色填充圆 -- 女性占比
    ballEnter.append("path").attr("class", "femaleCircle");
    ballGroup
      .select(".femaleCircle")
      .attr("fill", "#ff03b9")
      .attr("d", (d) => {
        const femaleData = [[d[1], d[0]]];
        if (femaleData[0][0] >= femaleData[0][1]) {
          return femaleArc(clockwisePie(femaleData[0])[0]);
        } else {
          return femaleArc(anticlockwisePie(femaleData[0])[0]);
        }
      });

    // 制作波浪纹 - clipPath
    const clipPathUpdate = this.defs.selectAll("clipPath").data(d3.range(1));
    clipPathUpdate.enter().append("clipPath").append("path");
    clipPathUpdate.exit().remove();

    const waveClipCount = 2;
    const waveClipWidth = radius * 4;
    const waveHeight = 10.26;
    const waveOffset = 0;
    const waveCount = 1;

    let wavaData = [];
    for (let i = 0; i <= 40 * waveClipCount; i++) {
      wavaData.push({
        x: i / (40 * waveClipCount),
        y: i / 40,
      });
    }

    const waveScaleX = d3
      .scaleLinear()
      .range([0, waveClipWidth])
      .domain([0, 1]);
    const waveScaleY = d3.scaleLinear().range([0, waveHeight]).domain([0, 1]);

    // translateY为radius 对应 0%
    // translateY为-radius 对应 100%
    const wavePercentScale = d3
      .scaleLinear()
      .domain([0, 100])
      .range([radius, -radius]);

    const clipArea = d3
      .area()
      .x((d) => {
        return waveScaleX(d.x);
      })
      .y0((d) => {
        return waveScaleY(
          Math.sin(
            Math.PI * 2 * waveOffset * -1 +
              Math.PI * 2 * (1 - waveCount) +
              d.y * 2 * Math.PI
          )
        );
      })
      .y1(2 * radius);

    let clipPath = this.defs
      .selectAll("clipPath")
      .attr("id", "areaWave")
      .select("path")
      .datum(wavaData)
      .attr("d", clipArea)
      .attr("fill", "yellow");

    clipPath
      .transition()
      .duration(2000)
      .attr("transform", `translate(${-3 * radius},${wavePercentScale(rate)})`)
      .on("start", () => {
        clipPath.attr("transform", `translate(${-3 * radius},${radius})`);
      });

    // 绘制图表名字
    ballEnter.append("text").attr("class", "chart-name");
    ballGroup
      .select(".chart-name")
      .attr("y", -radius / 4)
      .attr("text-anchor", "middle")
      .attr("fill", "#f4f8fc")
      .attr("font-weight", "bold")
      .attr("font-size", 30)
      .text("男性占比");

    // 绘制百分占比数值 -- 严格的绘制顺序决定层级
    ballEnter.append("text").attr("class", "valueText");
    ballGroup
      .select(".valueText")
      .attr("y", radius / 4 + 20)
      .attr("text-anchor", "middle")
      .attr("fill", "#f4f8fc")
      .attr("font-size", 70)
      .text(0)
      .transition()
      .duration(3000)
      .on("start", function () {
        d3.active(this).tween("text", function (d) {
          const that = d3.select(this);
          return function (t) {
            that.text(Math.floor(t * d[0]));
          };
        });
      });

    // 绘制value值百分比符号
    ballEnter.append("text").attr("class", "percentText");
    ballGroup
      .select(".percentText")
      .attr("y", 40)
      .attr("x", 70)
      .attr("text-anchor", "middle")
      .attr("fill", "#fff")
      .attr("font-size", 40)
      .text("%");

    // 用定时器做波浪动画
    setTimeout(function () {
      let distance = -3 * radius;
      d3.timer(() => {
        distance++;
        if (distance > -radius) {
          distance = -3 * radius;
        }
        clipPath.attr(
          "transform",
          `translate(${distance},${wavePercentScale(rate)})`
        );
      });
    }, 2000);
  }
}
```
